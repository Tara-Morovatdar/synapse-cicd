name: cicd-synapse
# Controls when the workflow will run
on:
  workflow_dispatch:
  # push:
  #   branches: [ workspace_publish ]
    # paths-ignore:
    #   - '.github/**'
    #   - 'build/**'
    #   - 'README.md'
    #   - 'CODEOWNERS'

# Modify the default permissions granted to GITHUB_TOKEN.
permissions:
      id-token: write
      contents: write
      packages: write

jobs: 
  deploy:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout local
        uses: actions/checkout@v3
      # - name: Setup Node.js environment
      #   uses: actions/setup-node@v3.4.1
      #   with:
      #     node-version: 14.x
        
      # - name: install npm Utilities package
      #   run: npm install
      #   working-directory: ${{github.workspace}}/build  # (1) provide the folder location of the package.json file

      # - name: Validate Synapse workspace
      #   uses: Azure/synapse-workspace-deployment@V1.8.0
      #   with:
      #     TargetWorkspaceName: 'synapse-uat-tm'
      #     ArtifactsFolder: './build'
      #     operation: 'validate'
      # - uses: actions/upload-artifact@v3
      #   with:
      #     name: ExportedArmTemplate
      #     path: ${{github.workspace}}/build/ExportedArmTemplate
      
      - name: Synapse workspace deployment
        uses: Azure/Synapse-workspace-deployment@V1.8.0
        with:
          TargetWorkspaceName: 'synapse-uat-tm'
          #ArtifactsFolder: './build'
          TemplateFile: '${{ github.workspace }}/synapse-dev-tm/TemplateForWorkspace.json'
          ParametersFile: '${{ github.workspace }}/synapse-dev-tm/TemplateParametersForWorkspace.json'
          environment: 'Azure Public'
          resourceGroup: 'Knauf-test'
          clientId: ${{ secrets.CLIENTID }}
          clientSecret: ${{ secrets.CLIENTSECRET }}
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenantId: ${{ secrets.AZURE_TENANT_ID }}
          DeleteArtifactsNotInTemplate: 'true'
          managedIdentity: 'False'
          operation: 'deploy'
